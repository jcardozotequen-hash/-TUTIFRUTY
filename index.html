<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üçé Tuti Fruti Multiplayer + Modo Solo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .card {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 25px;
      font-size: 2.2em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .instructions {
      background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 25px;
      border-left: 4px solid #667eea;
    }

    .instructions h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2em;
    }

    .instructions ul {
      padding-left: 20px;
      color: #555;
      line-height: 1.6;
    }

    .instructions li {
      margin-bottom: 8px;
    }

    .lobby-section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }

    input, button, select {
      padding: 12px 18px;
      border-radius: 10px;
      border: 2px solid #ddd;
      margin: 8px 6px;
      font-size: 16px;
      transition: all 0.3s ease;
      outline: none;
    }

    input:focus {
      border-color: #667eea;
      box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
      transform: translateY(-1px);
    }

    button {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .solo-btn {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      box-shadow: 0 6px 15px rgba(255, 107, 107, 0.3);
    }

    .stop-btn {
      background: linear-gradient(45deg, #ff6b6b, #dc3545);
      font-size: 18px;
      padding: 15px 25px;
      box-shadow: 0 6px 15px rgba(255, 107, 107, 0.4);
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .letter-display {
      font-size: 4em;
      font-weight: bold;
      color: #667eea;
      background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      padding: 25px;
      border-radius: 20px;
      text-align: center;
      min-width: 100px;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .timer-display {
      font-size: 1.8em;
      color: #333;
      font-weight: bold;
      background: rgba(255, 193, 7, 0.1);
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
    }

    .score-display {
      font-size: 1.4em;
      color: #333;
      background: rgba(40, 167, 69, 0.1);
      padding: 15px 20px;
      border-radius: 15px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
    }

    .game-board {
      overflow-x: auto;
      margin: 25px 0;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 15px;
      overflow: hidden;
    }

    th, td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      font-weight: bold;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    td input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }

    td input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
      transform: scale(1.02);
    }

    .input-correct {
      border-color: #28a745 !important;
      background: linear-gradient(45deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
      color: #28a745;
      font-weight: bold;
    }

    .input-error {
      border-color: #dc3545 !important;
      background: linear-gradient(45deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
      color: #dc3545;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .input-empty {
      border-color: #ffc107 !important;
      background: rgba(255, 193, 7, 0.1);
    }

    .error-message {
      position: absolute;
      background: #dc3545;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      white-space: nowrap;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
    }

    .error-message::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #dc3545;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    #results {
      margin-top: 25px;
      padding: 25px;
      background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .results-header {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      font-size: 1.5em;
    }

    .score-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .category-result {
      background: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
    }

    .category-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 1px;
    }

    .category-answer {
      font-size: 16px;
      margin-bottom: 8px;
      color: #555;
      font-style: italic;
    }

    .category-points {
      font-weight: bold;
      font-size: 16px;
    }

    .points-correct { color: #28a745; }
    .points-error { color: #dc3545; }
    .points-empty { color: #ffc107; }

    .lobby-players {
      background: rgba(102, 126, 234, 0.05);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
    }

    .player-item {
      background: white;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #667eea;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .muted {
      color: #666;
      font-size: 14px;
      font-style: italic;
    }

    .time-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }

    .current-letter-info {
      background: rgba(102, 126, 234, 0.1);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      margin: 15px 0;
      border: 2px solid rgba(102, 126, 234, 0.2);
    }

    .countdown-display {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      font-size: 8em;
      font-weight: bold;
      color: white;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    .online-status {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .online { background-color: #28a745; }
    .offline { background-color: #dc3545; }

    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
    }

    .connected {
      background: #28a745;
      color: white;
    }

    .disconnected {
      background: #dc3545;
      color: white;
    }

    .timer-warning {
      color: #dc3545 !important;
      animation: pulse 1s infinite;
    }

    .multiplayer-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .player-results {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #667eea;
    }

    .player-results h4 {
      text-align: center;
      margin-bottom: 15px;
      color: #333;
      font-size: 1.2em;
    }

    @media (max-width: 768px) {
      .card { padding: 15px; }
      h2 { font-size: 1.8em; }
      .letter-display { font-size: 2.5em; padding: 15px; }
      .game-header { justify-content: center; text-align: center; }
      th, td { padding: 8px; font-size: 14px; }
      td input { padding: 8px; font-size: 14px; }
      .controls { flex-direction: column; }
      button { width: 100%; }
    }

    #game { display: none; }
    #lobby { display: none; }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="connection-status" id="connectionStatus">üî¥ Desconectado</div>

  <div class="card">
    <h2>üçé Tuti Fruti Multiplayer + Solo</h2>

    <div class="instructions">
      <h3>üìù Instrucciones:</h3>
      <ul>
        <li>Completa cada categor√≠a con una palabra que empiece con la letra mostrada</li>
        <li>El timer inicia autom√°ticamente cuando aparece la letra</li>
        <li><strong>Puntuaci√≥n:</strong> Respuesta √∫nica = 10pts, Repetida = 5pts, Vac√≠a/Incorrecta = 0pts</li>
        <li>¬°Las palabras deben existir y empezar con la letra indicada!</li>
        <li>¬°S√© r√°pido y creativo!</li>
      </ul>
    </div>

    <div class="lobby-section">
      <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center;">
        <input id="name" placeholder="Tu nombre (ej: Juan)" style="min-width: 200px;">
        <input id="room" placeholder="ID de sala (ej: sala1)" style="min-width: 200px;">
        <button id="join">üö™ Entrar / Crear sala</button>
        <button id="leave" style="display:none">üö™ Salir</button>
        <button id="soloBtn" class="solo-btn">üéÆ Jugar Solo (Prueba)</button>
      </div>
      <p class="muted" style="text-align: center; margin-top: 15px;">
        üí° Host = primer jugador en entrar a la sala. M√°ximo 6 jugadores por sala.
      </p>

      <div id="lobby">
        <h3>üë• Jugadores en sala <span id="roomLabel"></span>:</h3>
        <div id="players" class="lobby-players"></div>
        
        <div class="time-controls">
          <label for="roundTime" style="font-weight: bold;">‚è± Tiempo por ronda:</label>
          <input id="roundTime" type="number" min="10" max="300" value="60" style="width:100px;">
          <span style="color: #666;">segundos</span>
          <button id="startRound">üéÆ Iniciar ronda (solo host)</button>
        </div>
        
        <div class="current-letter-info">
          <span style="font-weight: bold;">üéØ Letra actual: </span>
          <span id="currentLetter" style="font-size: 1.5em; font-weight: bold; color: #667eea;">A</span>
        </div>
      </div>
    </div>

    <div id="game" class="fade-in">
      <div class="game-header">
        <div class="letter-display pulse" id="gameLetter">A</div>
        <div class="timer-display">
          ‚è± Tiempo: <span id="timer">60</span>s
        </div>
        <div class="score-display">
          üèÜ Puntuaci√≥n: <span id="score">0</span> pts
        </div>
      </div>

      <div class="game-board">
        <table>
          <thead>
            <tr>
              <th>üë§ Nombre</th>
              <th>üêæ Animal</th>
              <th>üì¶ Cosa</th>
              <th>üçΩÔ∏è Comida</th>
              <th>üåç Pa√≠s/Ciudad</th>
              <th>üé® Color</th>
              <th>üíº Profesi√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="position: relative;">
                <input id="nombre" placeholder="Ana, Alberto...">
                <div class="error-message" style="display: none;"></div>
              </td>
              <td style="position: relative;">
                <input id="animal" placeholder="Abeja, Ardilla...">
                <div class="error-message" style="display: none;"></div>
              </td>
              <td style="position: relative;">
                <input id="cosa" placeholder="Avi√≥n, Agenda...">
                <div class="error-message" style="display: none;"></div>
              </td>
              <td style="position: relative;">
                <input id="comida" placeholder="Arroz, Aguacate...">
                <div class="error-message" style="display: none;"></div>
              </td>
              <td style="position: relative;">
                <input id="pais" placeholder="Argentina, Australia...">
                <div class="error-message" style="display: none;"></div>
              </td>
              <td style="position: relative;">
                <input id="color" placeholder="Azul, Amarillo...">
                <div class="error-message" style="display: none;"></div>
              </td>
              <td style="position: relative;">
                <input id="profesion" placeholder="Abogado, Arquitecto...">
                <div class="error-message" style="display: none;"></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="controls">
        <button id="stopBtn" class="stop-btn">üõë STOP</button>
        <button id="newRound">üéÆ Nueva Ronda</button>
        <button id="resetGame">üîÑ Reiniciar Juego</button>
      </div>

      <div id="results"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getDatabase, 
      ref, 
      set, 
      get, 
      push, 
      onValue, 
      off, 
      serverTimestamp, 
      onDisconnect,
      update
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Configuraci√≥n Firebase
    const firebaseConfig = {
      databaseURL: "https://tutifrutigame-b8409-default-rtdb.firebaseio.com",
      // Configuraci√≥n adicional para manejar permisos
      authDomain: "tutifrutigame-b8409.firebaseapp.com",
      projectId: "tutifrutigame-b8409",
      storageBucket: "tutifrutigame-b8409.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Variables globales
    let isSolo = false;
    let currentTime = 60;
    let timerInterval;
    let totalScore = 0;
    let currentGameLetter = 'A';
    let currentRoom = null;
    let currentPlayer = null;
    let isHost = false;
    let gameStarted = false;
    let playerId = 'player_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    let listeners = new Map();

    const categories = ["nombre", "animal", "cosa", "comida", "pais", "color", "profesion"];
    const categoryNames = {
      "nombre": "Nombre",
      "animal": "Animal", 
      "cosa": "Cosa",
      "comida": "Comida",
      "pais": "Pa√≠s/Ciudad",
      "color": "Color",
      "profesion": "Profesi√≥n"
    };

    // Diccionario para validaci√≥n
    const wordDictionary = {
      nombre: ['ana', 'alberto', 'antonio', 'andrea', 'alejandro', 'beatriz', 'benjamin', 'barbara', 'carlos', 'carmen', 'cristina', 'diego', 'diana', 'daniel', 'elena', 'eduardo', 'eva', 'fernando', 'francisca', 'gabriel', 'gloria', 'gonzalez', 'helena', 'hugo', 'isabel', 'ivan', 'jose', 'juan', 'julia', 'lucia', 'luis', 'maria', 'manuel', 'monica', 'nicolas', 'natalia', 'oscar', 'olga', 'patricia', 'pablo', 'raquel', 'ricardo', 'sofia', 'sergio', 'teresa', 'tomas', 'ursula', 'vicente', 'victoria', 'walter', 'ximena', 'yolanda', 'zenon'],
      animal: ['abeja', 'ardilla', 'ballena', 'burro', 'caballo', 'conejo', 'delfin', 'elefante', 'foca', 'gato', 'hipopotamo', 'iguana', 'jirafa', 'koala', 'leon', 'mono', 'nutria', 'oso', 'perro', 'quetzal', 'raton', 'serpiente', 'tigre', 'urraca', 'vaca', 'wallaby', 'yak', 'zorro'],
      cosa: ['avion', 'bicicleta', 'carro', 'disco', 'escalera', 'frasco', 'guitarra', 'hacha', 'iglesia', 'jarron', 'kilo', 'lapiz', 'mesa', 'nariz', 'olla', 'piano', 'queso', 'reloj', 'silla', 'telefono', 'uniforme', 'ventana', 'xilofono', 'yunque', 'zapato'],
      comida: ['arroz', 'banana', 'carne', 'dulce', 'empanada', 'frijol', 'galleta', 'hamburguesa', 'ice', 'jugo', 'kiwi', 'leche', 'manzana', 'naranja', 'omelet', 'pan', 'queso', 'refresco', 'sopa', 'tacos', 'uva', 'vino', 'waffle', 'yogurt', 'zanahoria'],
      pais: ['argentina', 'bolivia', 'colombia', 'dinamarca', 'espa√±a', 'francia', 'grecia', 'hungria', 'italia', 'japon', 'kenia', 'libano', 'mexico', 'noruega', 'holanda', 'peru', 'qatar', 'rusia', 'suecia', 'turquia', 'uganda', 'venezuela', 'yemen', 'zambia'],
      color: ['azul', 'blanco', 'cafe', 'dorado', 'esmeralda', 'fucsia', 'gris', 'hueso', 'indigo', 'jade', 'kaki', 'lila', 'magenta', 'naranja', 'ocre', 'purpura', 'quinacridona', 'rojo', 'salmon', 'turquesa', 'ultramar', 'violeta', 'whisky', 'amarillo', 'zinc'],
      profesion: ['abogado', 'bombero', 'chef', 'doctor', 'enfermero', 'fotografo', 'guardia', 'historiador', 'ingeniero', 'jardinero', 'kinesiologo', 'locutor', 'medico', 'nutricionista', 'odontologo', 'piloto', 'quimico', 'reportero', 'soldado', 'taxista', 'urbanista', 'veterinario', 'webmaster', 'youtuber', 'zoologo']
    };

    // Validaci√≥n de palabras
    async function validateWord(word, category) {
      if (!word || word.trim().length === 0) {
        return { valid: false, reason: 'empty' };
      }

      const cleanWord = word.trim().toLowerCase();
      const firstLetter = cleanWord.charAt(0);
      const expectedLetter = currentGameLetter.toLowerCase();

      if (firstLetter !== expectedLetter) {
        return { valid: false, reason: 'wrong_letter' };
      }

      if (wordDictionary[category] && wordDictionary[category].includes(cleanWord)) {
        return { valid: true, reason: 'dictionary_match' };
      }

      if (isNonsenseWord(cleanWord)) {
        return { valid: false, reason: 'nonsense' };
      }

      return { valid: true, reason: 'assumed_valid' };
    }

    function isNonsenseWord(word) {
      const vowels = 'aeiou';
      let consonantStreak = 0;
      let hasVowel = false;
      
      for (let char of word) {
        if (vowels.includes(char)) {
          hasVowel = true;
          consonantStreak = 0;
        } else {
          consonantStreak++;
        }
        
        if (consonantStreak > 4) return true;
      }

      if (!hasVowel && word.length > 2) return true;
      if (/(.)\1{3,}/.test(word)) return true;
      if (!/[a-z√°√©√≠√≥√∫√±√º]/.test(word)) return true;

      return false;
    }

    // Firebase functions
    function generateRandomLetter() {
      const letters = "ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ";
      return letters[Math.floor(Math.random() * letters.length)];
    }

    function updateConnectionStatus(connected) {
      const status = document.getElementById("connectionStatus");
      if (connected) {
        status.textContent = 'üü¢ Conectado';
        status.className = 'connection-status connected';
      } else {
        status.textContent = 'üî¥ Desconectado';
        status.className = 'connection-status disconnected';
      }
    }

    async function createOrJoinRoom(roomId, playerName) {
      try {
        const roomRef = ref(database, `rooms/${roomId}`);
        const roomSnapshot = await get(roomRef);
        
        let roomData;
        if (!roomSnapshot.exists()) {
          roomData = {
            id: roomId,
            host: playerId,
            status: 'waiting',
            currentLetter: 'A',
            timeRemaining: 60,
            createdAt: serverTimestamp(),
            maxPlayers: 6
          };
          
          await set(roomRef, roomData);
          isHost = true;
        } else {
          roomData = roomSnapshot.val();
          
          const playersSnapshot = await get(ref(database, `rooms/${roomId}/players`));
          const currentPlayers = playersSnapshot.exists() ? Object.keys(playersSnapshot.val()).length : 0;
          
          if (currentPlayers >= roomData.maxPlayers) {
            throw new Error('Sala llena! M√°ximo 6 jugadores.');
          }
          
          if (roomData.status === 'playing') {
            throw new Error('La partida ya est√° en curso. Espera a que termine.');
          }
        }

        const playerRef = ref(database, `rooms/${roomId}/players/${playerId}`);
        await set(playerRef, {
          id: playerId,
          name: playerName,
          score: 0,
          online: true,
          joinedAt: serverTimestamp()
        });

        setupPresence(roomId);
        
        currentRoom = roomId;
        currentPlayer = playerName;
        
        listenToRoom(roomId);
        updateConnectionStatus(true);
        
        return true;
        
      } catch (error) {
        console.error('Error al unirse a la sala:', error);
        alert(`Error: ${error.message}`);
        return false;
      }
    }

    function setupPresence(roomId) {
      const presenceRef = ref(database, `rooms/${roomId}/players/${playerId}/online`);
      
      set(presenceRef, true);
      onDisconnect(presenceRef).set(false);
    }

    function listenToRoom(roomId) {
      clearListeners();
      
      const playersRef = ref(database, `rooms/${roomId}/players`);
      const playersListener = onValue(playersRef, (snapshot) => {
        if (snapshot.exists()) {
          const players = snapshot.val();
          updatePlayersList(players);
        }
      });
      
      listeners.set('players', playersListener);
      
      const roomRef = ref(database, `rooms/${roomId}`);
      const roomListener = onValue(roomRef, (snapshot) => {
        if (snapshot.exists()) {
          const roomData = snapshot.val();
          
          if (roomData.host === playerId) {
            isHost = true;
            updateHostControls();
          }
          
          // Sincronizar la letra actual para todos los jugadores
          if (roomData.currentLetter && roomData.currentLetter !== currentGameLetter) {
            currentGameLetter = roomData.currentLetter;
            document.getElementById("currentLetter").textContent = currentGameLetter;
            document.getElementById("gameLetter").textContent = currentGameLetter;
            updatePlaceholders();
          }
          
          if (roomData.status === 'playing' && !gameStarted) {
            handleGameStart(roomData);
          } else if (roomData.status === 'finished') {
            handleGameEnd(roomData);
          }
        }
      });
      
      listeners.set('room', roomListener);
      
      // Escuchar cuando alguien dice STOP
      const stopRef = ref(database, `gameStates/${roomId}/playerStopped`);
      const stopListener = onValue(stopRef, (snapshot) => {
        if (snapshot.exists() && gameStarted) {
          const stopData = snapshot.val();
          handleSomeoneStoppedGame(stopData);
        }
      });
      
      listeners.set('stop', stopListener);
    }

    function clearListeners() {
      listeners.forEach((listener) => {
        if (typeof listener === 'function') {
          off(listener);
        }
      });
      listeners.clear();
    }

    async function leaveRoom() {
      if (!currentRoom) return;
      
      try {
        if (isHost) {
          await transferHost();
        }
        
        const playerRef = ref(database, `rooms/${currentRoom}/players/${playerId}`);
        await set(playerRef, null);
        
        clearListeners();
        currentRoom = null;
        currentPlayer = null;
        isHost = false;
        
        hideLobby();
        updateConnectionStatus(false);
        
      } catch (error) {
        console.error('Error al salir de la sala:', error);
      }
    }

    async function transferHost() {
      try {
        const playersRef = ref(database, `rooms/${currentRoom}/players`);
        const playersSnapshot = await get(playersRef);
        
        if (playersSnapshot.exists()) {
          const players = playersSnapshot.val();
          const playerIds = Object.keys(players).filter(id => id !== playerId);
          
          if (playerIds.length > 0) {
            const newHostId = playerIds[0];
            await set(ref(database, `rooms/${currentRoom}/host`), newHostId);
          } else {
            await set(ref(database, `rooms/${currentRoom}`), null);
          }
        }
      } catch (error) {
        console.error('Error al transferir host:', error);
      }
    }

    async function startMultiplayerGame(timeLimit) {
      if (!isHost || !currentRoom) {
        throw new Error('Solo el host puede iniciar el juego');
      }
      
      try {
        // El host genera la letra aleatoria que todos usar√°n
        const letters = "ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ";
        const randomLetter = letters[Math.floor(Math.random() * letters.length)];
        
        await update(ref(database, `rooms/${currentRoom}`), {
          status: 'playing',
          currentLetter: randomLetter,
          timeRemaining: timeLimit,
          gameStartedAt: serverTimestamp()
        });
        
        const gameStateRef = ref(database, `gameStates/${currentRoom}`);
        await set(gameStateRef, {
          roundAnswers: {},
          validations: {},
          roundScores: {},
          totalScores: {}
        });
        
        return true;
        
      } catch (error) {
        console.error('Error al iniciar juego:', error);
        throw error;
      }
    }

    async function submitAnswers(answers) {
      if (!currentRoom || !playerId) return;
      
      try {
        const answersRef = ref(database, `gameStates/${currentRoom}/roundAnswers/${playerId}`);
        await set(answersRef, {
          ...answers,
          submittedAt: serverTimestamp(),
          playerId: playerId,
          playerName: currentPlayer
        });
        
        return true;
        
      } catch (error) {
        console.error('Error al enviar respuestas:', error);
        return false;
      }
    }

    // Nueva funci√≥n para manejar STOP de cualquier jugador
    async function handlePlayerStop() {
      if (!currentRoom || !playerId) return;
      
      try {
        // Marcar que este jugador dijo STOP
        await set(ref(database, `gameStates/${currentRoom}/playerStopped`), {
          playerId: playerId,
          playerName: currentPlayer,
          stoppedAt: serverTimestamp()
        });
        
        // Si soy host, terminar la ronda inmediatamente
        if (isHost) {
          await finishMultiplayerRound();
        }
        
      } catch (error) {
        console.error('Error al procesar STOP:', error);
      }
    }

    async function finishMultiplayerRound() {
      if (!isHost || !currentRoom) return;
      
      try {
        await set(ref(database, `rooms/${currentRoom}/status`), 'finished');
        
        const gameStateRef = ref(database, `gameStates/${currentRoom}/roundAnswers`);
        const answersSnapshot = await get(gameStateRef);
        
        if (answersSnapshot.exists()) {
          const allAnswers = answersSnapshot.val();
          const results = await processAnswers(allAnswers);
          
          await set(ref(database, `gameStates/${currentRoom}/roundResults`), results);
          await updateTotalScores(results);
        }
        
      } catch (error) {
        console.error('Error al finalizar ronda:', error);
      }
    }

    async function processAnswers(allAnswers) {
      const results = {};
      const answersByCategory = {};
      
      categories.forEach(cat => {
        answersByCategory[cat] = {};
      });
      
      Object.entries(allAnswers).forEach(([playerId, playerAnswers]) => {
        categories.forEach(category => {
          const answer = playerAnswers[category]?.toLowerCase().trim();
          if (answer) {
            if (!answersByCategory[category][answer]) {
              answersByCategory[category][answer] = [];
            }
            answersByCategory[category][answer].push(playerId);
          }
        });
      });
      
      for (const [pid, playerAnswers] of Object.entries(allAnswers)) {
        results[pid] = {
          answers: playerAnswers,
          scores: {},
          totalScore: 0
        };
        
        for (const category of categories) {
          const answer = playerAnswers[category]?.toLowerCase().trim();
          let points = 0;
          
          if (!answer) {
            points = 0;
          } else {
            const validation = await validateWord(answer, category);
            if (!validation.valid) {
              points = 0;
            } else {
              const playersWithSameAnswer = answersByCategory[category][answer];
              points = playersWithSameAnswer.length === 1 ? 10 : 5;
            }
          }
          
          results[pid].scores[category] = points;
          results[pid].totalScore += points;
        }
      }
      
      return results;
    }

    async function updateTotalScores(roundResults) {
      try {
        const updates = {};
        
        for (const [pid, result] of Object.entries(roundResults)) {
          const playerRef = ref(database, `rooms/${currentRoom}/players/${pid}`);
          const playerSnapshot = await get(playerRef);
          
          if (playerSnapshot.exists()) {
            const currentScore = playerSnapshot.val().score || 0;
            updates[`rooms/${currentRoom}/players/${pid}/score`] = currentScore + result.totalScore;
          }
        }
        
        await update(ref(database), updates);
        
      } catch (error) {
        console.error('Error al actualizar puntuaciones:', error);
      }
    }

    function handleGameStart(roomData) {
      // Solo mostrar el juego si no se est√° jugando ya
      if (gameStarted) return;
      
      document.getElementById("lobby").style.display = "none";
      document.getElementById("game").style.display = "block";
      
      // IMPORTANTE: Usar la letra del servidor, no generar una nueva
      currentGameLetter = roomData.currentLetter;
      currentTime = roomData.timeRemaining;
      
      document.getElementById("gameLetter").textContent = currentGameLetter;
      document.getElementById("currentLetter").textContent = currentGameLetter;
      document.getElementById("timer").textContent = currentTime;
      
      updatePlaceholders();
      clearInputs();
      
      // Sincronizar inicio para todos los jugadores
      showCountdown(() => {
        startSyncedTimer(roomData.gameStartedAt, roomData.timeRemaining);
        document.getElementById('nombre').focus();
      });
      
      gameStarted = true;
    }

    function startSyncedTimer(startTime, duration) {
      if (timerInterval) clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        const now = Date.now();
        const elapsed = Math.floor((now - startTime) / 1000);
        const remaining = Math.max(0, duration - elapsed);
        
        currentTime = remaining;
        document.getElementById("timer").textContent = remaining;
        
        if (remaining <= 10) {
          document.getElementById("timer").parentElement.classList.add('timer-warning');
        }
        
        if (remaining <= 0) {
          clearInterval(timerInterval);
          handleTimeUp();
        }
      }, 1000);
    }

    async function handleTimeUp() {
      const answers = {};
      categories.forEach(cat => {
        const input = document.getElementById(cat);
        answers[cat] = input.value.trim();
        input.disabled = true;
      });
      
      await submitAnswers(answers);
      
      if (isHost) {
        await finishMultiplayerRound();
      }
    }

    function handleGameEnd() {
      clearInterval(timerInterval);
      gameStarted = false;
      displayMultiplayerResults();
    }

    function updatePlayersList(players) {
      const playersDiv = document.getElementById("players");
      if (!playersDiv) return;
      
      playersDiv.innerHTML = '';
      
      Object.values(players).forEach(player => {
        const playerDiv = document.createElement('div');
        playerDiv.className = 'player-item';
        playerDiv.innerHTML = `
          <div>
            <span class="online-status ${player.online ? 'online' : 'offline'}"></span>
            <strong>${player.name}</strong>
            ${player.id === playerId && isHost ? ' üëë (Host)' : ''}
          </div>
          <div>
            üèÜ ${player.score || 0} pts
          </div>
        `;
        playersDiv.appendChild(playerDiv);
      });
    }

    function updateHostControls() {
      const startBtn = document.getElementById("startRound");
      if (startBtn) {
        startBtn.style.display = isHost ? "inline-block" : "none";
      }
    }

    function showLobby() {
      document.getElementById("lobby").style.display = "block";
      document.getElementById("roomLabel").textContent = currentRoom;
      updateHostControls();
    }

    function hideLobby() {
      document.getElementById("lobby").style.display = "none";
    }

    async function displayMultiplayerResults() {
      try {
        const resultsRef = ref(database, `gameStates/${currentRoom}/roundResults`);
        const resultsSnapshot = await get(resultsRef);
        
        if (resultsSnapshot.exists()) {
          const results = resultsSnapshot.val();
          
          let html = `
            <div class="results-header">
              üèÜ Resultados de la Ronda
            </div>
            <div class="multiplayer-results">
          `;
          
          Object.entries(results).forEach(([pid, result]) => {
            html += `
              <div class="player-results">
                <h4>${result.answers.playerName || 'Jugador'} - ${result.totalScore} pts</h4>
                <div class="score-breakdown">
            `;
            
            Object.entries(result.scores).forEach(([category, points]) => {
              const answer = result.answers[category] || 'Sin respuesta';
              html += `
                <div class="category-result">
                  <div class="category-name">${categoryNames[category]}</div>
                  <div class="category-answer">"${answer}"</div>
                  <div class="category-points points-${points > 0 ? 'correct' : 'error'}">
                    ${points} pts
                  </div>
                </div>
              `;
            });
            
            html += `</div></div>`;
          });
          
          html += '</div>';
          document.getElementById("results").innerHTML = html;
        }
        
      } catch (error) {
        console.error('Error al mostrar resultados:', error);
      }
    }

    // Funciones del juego solo
    function setDefaultLetter() {
      const letters = "ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ";
      currentGameLetter = letters[Math.floor(Math.random() * letters.length)];
      document.getElementById("currentLetter").textContent = currentGameLetter;
      document.getElementById("gameLetter").textContent = currentGameLetter;
      updatePlaceholders();
    }

    function showGameByDefault() {
      document.getElementById("game").style.display = "block";
      document.getElementById("game").classList.add("fade-in");
      isSolo = true;
      
      currentTime = parseInt(document.getElementById("roundTime").value) || 60;
      document.getElementById("timer").textContent = currentTime;
      document.getElementById("score").textContent = totalScore;
      
      setTimeout(() => {
        document.getElementById('nombre').focus();
      }, 500);
    }

    function updatePlaceholders() {
      const examples = {
        'A': { nombre: 'Ana, Alberto...', animal: 'Abeja, Ardilla...', cosa: 'Avi√≥n, Agenda...', comida: 'Arroz, Aguacate...', pais: 'Argentina, Australia...', color: 'Azul, Amarillo...', profesion: 'Abogado, Arquitecto...' },
        'B': { nombre: 'Bruno, Beatriz...', animal: 'B√∫ho, Ballena...', cosa: 'Bicicleta, Botella...', comida: 'Banana, Bistec...', pais: 'Brasil, B√©lgica...', color: 'Blanco, Beige...', profesion: 'Bombero, Bailar√≠n...' },
        'C': { nombre: 'Carlos, Carmen...', animal: 'Caballo, Conejo...', cosa: 'Carro, Computadora...', comida: 'Carne, Chocolate...', pais: 'Colombia, Chile...', color: 'Celeste, Caf√©...', profesion: 'Chef, Contador...' }
      };
      
      const defaultExamples = {
        nombre: `${currentGameLetter}na, ${currentGameLetter}lberto...`,
        animal: `${currentGameLetter}beja, ${currentGameLetter}rdilla...`,
        cosa: `${currentGameLetter}vi√≥n, ${currentGameLetter}genda...`,
        comida: `${currentGameLetter}rroz, ${currentGameLetter}guacate...`,
        pais: `${currentGameLetter}rgentina, ${currentGameLetter}ustralia...`,
        color: `${currentGameLetter}zul, ${currentGameLetter}marillo...`,
        profesion: `${currentGameLetter}bogado, ${currentGameLetter}rquitecto...`
      };
      
      const placeholders = examples[currentGameLetter] || defaultExamples;
      
      categories.forEach(cat => {
        const input = document.getElementById(cat);
        if (input) {
          input.placeholder = placeholders[cat] || `${categoryNames[cat]} con ${currentGameLetter}...`;
        }
      });
    }

    function setupInputValidation() {
      categories.forEach(category => {
        const input = document.getElementById(category);
        if (!input) return;
        
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            if (isSolo) {
              finishSoloRound();
            }
          }
        });

        let validationTimeout;
        input.addEventListener('input', function() {
          clearTimeout(validationTimeout);
          validationTimeout = setTimeout(async () => {
            await validateInput(this, category);
          }, 500);
        });
      });
    }

    async function validateInput(input, category) {
      const value = input.value.trim();
      const errorMsg = input.parentElement.querySelector('.error-message');
      
      input.classList.remove('input-correct', 'input-error', 'input-empty');
      if (errorMsg) errorMsg.style.display = 'none';
      
      if (value === '') {
        input.classList.add('input-empty');
        return;
      }
      
      const validation = await validateWord(value, category);
      
      if (validation.valid) {
        input.classList.add('input-correct');
        if (errorMsg) errorMsg.style.display = 'none';
      } else {
        input.classList.add('input-error');
        if (errorMsg) {
          let errorText = '';
          switch (validation.reason) {
            case 'wrong_letter':
              errorText = `¬°Error! Debe empezar con "${currentGameLetter}"`;
              break;
            case 'nonsense':
              errorText = '¬°Esa palabra no existe!';
              break;
            case 'empty':
              errorText = 'Campo vac√≠o';
              break;
            default:
              errorText = 'Palabra inv√°lida';
          }
          
          errorMsg.textContent = errorText;
          errorMsg.style.display = 'block';
          
          setTimeout(() => {
            if (errorMsg) errorMsg.style.display = 'none';
          }, 4000);
        }
      }
    }

    function showCountdown(callback) {
      const countdownDiv = document.createElement('div');
      countdownDiv.className = 'countdown-display';
      document.body.appendChild(countdownDiv);
      
      let count = 3;
      
      const countInterval = setInterval(() => {
        if (count > 0) {
          countdownDiv.textContent = count;
          countdownDiv.style.animation = 'pulse 1s ease-in-out';
        } else {
          countdownDiv.textContent = '¬°GO!';
          countdownDiv.style.color = '#28a745';
          
          setTimeout(() => {
            document.body.removeChild(countdownDiv);
            callback();
          }, 1000);
          
          clearInterval(countInterval);
        }
        count--;
      }, 1000);
    }

    function startSoloGame(letter, time) {
      document.getElementById("lobby").style.display = "none";
      document.getElementById("game").style.display = "block";
      document.getElementById("game").classList.add("fade-in");
      
      currentGameLetter = letter;
      document.getElementById("currentLetter").textContent = letter;
      document.getElementById("gameLetter").textContent = letter;
      currentTime = time;
      document.getElementById("timer").textContent = time;
      
      updatePlaceholders();
      clearInputs();
      document.getElementById("results").innerHTML = "";
      gameStarted = true;
      
      showCountdown(() => {
        startTimer();
        document.getElementById('nombre').focus();
      });
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        currentTime--;
        document.getElementById("timer").textContent = currentTime;
        
        if (currentTime <= 10) {
          document.getElementById("timer").parentElement.classList.add('timer-warning');
        } else {
          document.getElementById("timer").parentElement.classList.remove('timer-warning');
        }
        
        if (currentTime <= 0) {
          clearInterval(timerInterval);
          finishSoloRound();
        }
      }, 1000);
    }

    function clearInputs() {
      categories.forEach(cat => {
        const input = document.getElementById(cat);
        if (input) {
          input.value = '';
          input.classList.remove('input-correct', 'input-error', 'input-empty');
          input.disabled = false;
          
          const errorMsg = input.parentElement.querySelector('.error-message');
          if (errorMsg) errorMsg.style.display = 'none';
        }
      });
    }

    async function finishSoloRound() {
      clearInterval(timerInterval);
      gameStarted = false;
      
      categories.forEach(cat => {
        const input = document.getElementById(cat);
        if (input) input.disabled = true;
      });
      
      let roundScore = 0;
      const results = [];
      
      for (const cat of categories) {
        const input = document.getElementById(cat);
        const answer = input.value.trim();
        
        const validation = await validateWord(answer, cat);
        let points = 0;
        let status = 'empty';
        
        if (!answer) {
          points = 0;
          status = 'empty';
        } else if (!validation.valid) {
          points = 0;
          status = 'error';
        } else {
          points = 10;
          status = 'correct';
        }
        
        roundScore += points;
        results.push({
          category: cat,
          answer: answer,
          points: points,
          status: status,
          validation: validation
        });
      }
      
      totalScore += roundScore;
      document.getElementById("score").textContent = totalScore;
      
      displaySoloResults(results, roundScore);
    }

    function displaySoloResults(results, roundScore) {
      document.getElementById("results").innerHTML = `
        <div class="results-header">
          üìä Resultados de la Ronda
          <div style="font-size: 1.8em; margin: 10px 0; color: #667eea;">
            +${roundScore} puntos
          </div>
        </div>
        <div class="score-breakdown" id="scoreBreakdown">
        </div>
      `;
      
      const breakdown = document.getElementById('scoreBreakdown');
      
      results.forEach(result => {
        const div = document.createElement('div');
        div.className = 'category-result';
        
        let statusEmoji = '';
        let statusClass = '';
        let statusText = '';
        
        switch(result.status) {
          case 'correct':
            statusEmoji = '‚úÖ';
            statusClass = 'points-correct';
            statusText = 'Correcto';
            break;
          case 'error':
            statusEmoji = '‚ùå';
            statusClass = 'points-error';
            if (result.validation.reason === 'wrong_letter') {
              statusText = `No empieza con "${currentGameLetter}"`;
            } else if (result.validation.reason === 'nonsense') {
              statusText = 'Palabra inexistente';
            } else {
              statusText = 'Palabra inv√°lida';
            }
            break;
          case 'empty':
            statusEmoji = '‚ö™';
            statusClass = 'points-empty';
            statusText = 'Sin respuesta';
            break;
        }
        
        div.innerHTML = `
          <div class="category-name">${categoryNames[result.category]}</div>
          <div class="category-answer">"${result.answer || 'Sin respuesta'}"</div>
          <div class="category-points ${statusClass}">
            ${statusEmoji} ${statusText} - ${result.points} pts
          </div>
        `;
        
        breakdown.appendChild(div);
      });
    }

    // Event listeners
    window.onload = function() {
      setDefaultLetter();
      setupInputValidation();
      showGameByDefault();
    };

    document.getElementById("join").onclick = async () => {
      const name = document.getElementById("name").value.trim();
      const room = document.getElementById("room").value.trim();
      
      if (!name || !room) {
        alert('‚ö†Ô∏è Por favor ingresa tu nombre y el ID de la sala');
        return;
      }
      
      if (name.length > 20) {
        alert('‚ö†Ô∏è El nombre debe tener m√°ximo 20 caracteres');
        return;
      }
      
      if (await createOrJoinRoom(room, name)) {
        document.getElementById("join").style.display = "none";
        document.getElementById("leave").style.display = "inline-block";
        document.getElementById("name").disabled = true;
        document.getElementById("room").disabled = true;
        
        showLobby();
        alert(`‚úÖ Te uniste a la sala "${room}" como "${name}"`);
      }
    };

    document.getElementById("leave").onclick = async () => {
      if (confirm('¬øEst√°s seguro de que quieres salir de la sala?')) {
        await leaveRoom();
        
        document.getElementById("join").style.display = "inline-block";
        document.getElementById("leave").style.display = "none";
        document.getElementById("name").disabled = false;
        document.getElementById("room").disabled = false;
        
        alert('‚ùå Saliste de la sala');
      }
    };

    document.getElementById("soloBtn").onclick = () => {
      isSolo = true;
      const letters = "ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ";
      const letra = letters[Math.floor(Math.random() * letters.length)];
      currentTime = parseInt(document.getElementById("roundTime").value) || 60;
      startSoloGame(letra, currentTime);
    };

    document.getElementById("startRound").onclick = async () => {
      if (!isHost) {
        alert('‚ö†Ô∏è Solo el host puede iniciar la ronda');
        return;
      }
      
      try {
        const tiempo = parseInt(document.getElementById("roundTime").value) || 60;
        
        // Ya no pasamos la letra como par√°metro, se genera en la funci√≥n
        await startMultiplayerGame(tiempo);
        isSolo = false;
        
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    };

    document.getElementById("stopBtn").onclick = async () => {
      if (gameStarted && timerInterval) {
        if (isSolo) {
          finishSoloRound();
        } else {
          await handleTimeUp();
        }
      }
    };

    document.getElementById("newRound").onclick = () => {
      const letters = "ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ";
      const letra = letters[Math.floor(Math.random() * letters.length)];
      currentTime = parseInt(document.getElementById("roundTime").value) || 60;
      startSoloGame(letra, currentTime);
    };

    document.getElementById("resetGame").onclick = () => {
      if (confirm('¬øQuieres reiniciar el juego completamente?')) {
        totalScore = 0;
        document.getElementById("score").textContent = '0';
        document.getElementById("results").innerHTML = '';
        clearInputs();
        setDefaultLetter();
        gameStarted = false;
        
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
    };

    window.addEventListener('beforeunload', () => {
      if (currentRoom) {
        leaveRoom();
      }
    });
  </script>
</body>
</html>
